<script>
  function getIPVersion(ip) {
    if (/^\d{1,3}(\.\d{1,3}){3}$/.test(ip)) return "IPv4";
    if (/^[a-fA-F0-9:]+$/.test(ip)) return "IPv6";
    return "未知类型";
  }

  function detectDevice() {
    const ua = navigator.userAgent;
    const el = document.getElementById("deviceInfo");

    let system = "未知系统";
    let browser = "未知浏览器";
    let iconSystem = "";
    let iconBrowser = "";

    if (/Android/i.test(ua)) {
      system = "Android";
      iconSystem = '<i class="fab fa-android"></i>';
    } else if (/iPhone|iPad/i.test(ua)) {
      system = "iOS";
      iconSystem = '<i class="fab fa-apple"></i>';
    } else if (/Windows/i.test(ua)) {
      system = "Windows";
      iconSystem = '<i class="fab fa-windows"></i>';
    } else if (/Macintosh/i.test(ua)) {
      system = "macOS";
      iconSystem = '<i class="fab fa-apple"></i>';
    }

    if (/Chrome/i.test(ua)) {
      browser = "Chrome";
      iconBrowser = '<i class="fab fa-chrome"></i>';
    } else if (/Firefox/i.test(ua)) {
      browser = "Firefox";
      iconBrowser = '<i class="fab fa-firefox-browser"></i>';
    } else if (/Safari/i.test(ua) && !/Chrome/i.test(ua)) {
      browser = "Safari";
      iconBrowser = '<i class="fab fa-safari"></i>';
    } else if (/Edg/i.test(ua)) {
      browser = "Edge";
      iconBrowser = '<i class="fab fa-edge"></i>';
    }

    el.innerHTML = `💻 系统：${iconSystem} ${system}<br>🌐 浏览器：${iconBrowser} ${browser}`;
  }

  async function loadMyIP() {
    const el = document.getElementById("myIpInfo");
    const loadingEl = document.getElementById("myIpLoading");
    try {
      const resIp = await fetch("https://api.ipify.org?format=json");
      const { ip } = await resIp.json();

      const res = await fetch(`https://ipapi.co/${ip}/json`);
      const data = await res.json();
      if(data.error) throw new Error(data.reason || "查询失败");

      const version = getIPVersion(ip);
      const flagUrl = data.country_code ? `https://flagcdn.com/w40/${data.country_code.toLowerCase()}.png` : '';
      const flagImg = flagUrl ? `<img src="${flagUrl}" alt="国旗" class="flag" />` : '';

      el.innerHTML = `
        📌 IP：${data.ip} ${flagImg} <br>
        🔎 类型：${version} <br>
        🌍 位置：${data.city}, ${data.region}, ${data.country_name} <br>
        📡 ISP：${data.org || '未知'} <br>
        🧭 经纬度：${data.latitude}, ${data.longitude} <br>
        ⏰ 时区：${data.timezone}
      `;
    } catch (e) {
      el.innerText = "❌ 查询失败，请稍后再试";
    } finally {
      loadingEl.style.display = "none";
    }
  }

  async function queryIP() {
    const ip = document.getElementById("ipInput").value.trim();
    if (!ip) {
      alert("请输入 IP 地址！");
      return;
    }
    const resEl = document.getElementById("result");
    resEl.innerHTML = '查询中... <span class="loading"></span>';
    try {
      const res = await fetch(`https://ipapi.co/${ip}/json`);
      const data = await res.json();
      if(data.error) throw new Error(data.reason || "查询失败");

      const version = getIPVersion(ip);
      const flagUrl = data.country_code ? `https://flagcdn.com/w40/${data.country_code.toLowerCase()}.png` : '';
      const flagImg = flagUrl ? `<img src="${flagUrl}" alt="国旗" class="flag" />` : '';

      resEl.innerHTML = `
        📌 IP：${data.ip} ${flagImg} <br>
        🔎 类型：${version} <br>
        🌍 位置：${data.city}, ${data.region}, ${data.country_name} <br>
        📡 ISP：${data.org || '未知'} <br>
        🧭 经纬度：${data.latitude}, ${data.longitude} <br>
        ⏰ 时区：${data.timezone}
      `;
      saveHistory(ip);
    } catch (e) {
      resEl.innerHTML = `<span style="color:#ff5555;">❌ 查询失败：${e.message}</span>`;
    }
  }

  function getHistory() {
    try {
      return JSON.parse(localStorage.getItem("ipQueryHistory")) || [];
    } catch {
      return [];
    }
  }

  function saveHistory(ip) {
    let history = getHistory();
    if (!history.includes(ip)) {
      history.unshift(ip);
      if (history.length > 5) history.pop();
      localStorage.setItem("ipQueryHistory", JSON.stringify(history));
    }
    renderHistory();
  }

  function renderHistory() {
    const history = getHistory();
    const container = document.getElementById("historyList");
    if (history.length === 0) {
      container.innerHTML = "<em>暂无查询历史</em>";
      return;
    }
    container.innerHTML = "查询历史: ";
    history.forEach(ip => {
      const span = document.createElement("span");
      span.textContent = ip;
      span.onclick = () => {
        document.getElementById("ipInput").value = ip;
        queryIP();
      };
      container.appendChild(span);
    });
  }

  window.onload = () => {
    detectDevice();
    loadMyIP();
    renderHistory();
  };
</script>
