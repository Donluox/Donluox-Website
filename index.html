<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>What Is My IP</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
<!-- å¼•å…¥åœ°å›¾æ ·å¼ -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
body {
  background: #0d1117;
  color: #fff;
  font-family: 'Segoe UI', sans-serif;
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  padding: 20px;
  margin: 0;
}
header {
  text-align: center;
  font-size: 2rem;
  color: #00e676;
  font-weight: 700;
  margin-bottom: 25px;
  text-shadow: 0 0 8px #00e676aa;
}
.card {
  background-color: #1e1e1e;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 0 12px rgba(0,0,0,0.5);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  max-width: 800px;
  margin-left: auto; 
  margin-right: auto;
  width: 100%;
  box-sizing: border-box;
}
.card:hover {
  transform: translateY(-2px);
  box-shadow: 0 0 15px rgba(0,230,118,0.2);
}
.card h2 {
  margin-top: 0;
  margin-bottom: 15px;
  color: #00e676;
  font-size: 1.3rem;
  display: flex;
  align-items: center;
  border-bottom: 1px solid #333;
  padding-bottom: 10px;
}
.card h2 span {
  margin-right: 8px;
}
.input-group { margin-bottom: 15px; display: flex; gap: 10px; }
input {
  flex: 1;
  padding: 10px;
  border-radius: 6px;
  border: 1px solid #333;
  background-color: #222;
  color: #eee;
  font-size: 15px;
  outline: none;
}
input:focus { border-color: #00e676; }
button {
  padding: 10px 18px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  background-color: #00c853;
  color: #fff;
  font-size: 15px;
  transition: background 0.3s ease;
  white-space: nowrap;
}
button:hover { background-color: #00e676; }
.info { font-size: 15px; line-height: 1.8; }
.flag { width: 24px; height: auto; vertical-align: middle; margin-left: 6px; border-radius: 2px; }
.history-list { margin-top: 10px; font-size: 13px; color: #aaa; }
.history-list span {
  cursor: pointer;
  margin-right: 8px;
  padding: 3px 8px;
  border-radius: 4px;
  background: #2a2a2a;
  border: 1px solid #333;
  display: inline-block;
  margin-bottom: 5px;
  transition: 0.2s;
}
.history-list span:hover { border-color: #00e676; color: #00e676; }
.loading {
  display: inline-block;
  width: 18px; height: 18px;
  border: 3px solid #00e676;
  border-radius: 50%;
  border-top-color: transparent;
  animation: spin 1s linear infinite;
  vertical-align: middle;
  margin-left: 8px;
}
footer {
  text-align: center;
  margin-top: auto;
  color: #777;
  font-size: 13px;
  padding: 12px 0;
}

/* æ–°å¢ï¼šç±»å‹æ ‡ç­¾æ ·å¼ */
.badge {
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
    margin-left: 5px;
}
.type-res { color: #00e676; background: rgba(0,230,118,0.1); border: 1px solid rgba(0,230,118,0.3); }
.type-dc { color: #ff5252; background: rgba(255,82,82,0.1); border: 1px solid rgba(255,82,82,0.3); }

/* åœ°å›¾å®¹å™¨ */
#map { width: 100%; height: 200px; margin-top: 15px; border-radius: 8px; display: none; }
.device-icon, .browser-icon { margin-right:6px; width: 20px; text-align: center;}

@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<header>ğŸŒ What Is My IP</header>

<div class="card">
  <h2><span>ğŸ“</span> å½“å‰ç½‘ç»œç¯å¢ƒ</h2>
  <div class="info" id="myIpInfo">æŸ¥è¯¢ä¸­... <span class="loading"></span></div>
</div>

<div class="card">
  <h2><span>ğŸ”</span> æ‰‹åŠ¨æŸ¥è¯¢å…¶ä»– IP</h2>
  <div class="input-group">
    <input type="text" id="ipInput" placeholder="è¾“å…¥ IP åœ°å€">
    <button onclick="queryIP()">æŸ¥è¯¢</button>
  </div>
  <div class="info" id="result"></div>
  <!-- åœ°å›¾æ˜¾ç¤ºä½ç½® -->
  <div id="map"></div>
  <div class="history-list" id="historyList"></div>
</div>

<div class="card">
  <h2><span>ğŸ–¥ï¸</span> ç”¨æˆ·è®¾å¤‡ / æµè§ˆå™¨</h2>
  <div class="info" id="deviceInfo">åŠ è½½ä¸­...</div>
</div>

<footer>è”ç³»æˆ‘: <a href="mailto:abc@donluox.dpdns.org" style="color:#00e676; text-decoration:none;">abc@donluox.dpdns.org</a></footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// 1. è®¾å¤‡æ£€æµ‹ (ä¿æŒåŸæ ·)
function detectDevice() {
  const ua = navigator.userAgent;
  const el = document.getElementById("deviceInfo");
  let system="æœªçŸ¥ç³»ç»Ÿ", browser="æœªçŸ¥æµè§ˆå™¨";
  let sysIcon='<i class="fa-solid fa-desktop device-icon"></i>';
  let brIcon='<i class="fa-solid fa-globe browser-icon"></i>';
  
  if(/Android/i.test(ua)){ system="Android"; sysIcon='<i class="fab fa-android device-icon"></i>'; }
  else if(/iPhone|iPad/i.test(ua)){ system="iOS"; sysIcon='<i class="fab fa-apple device-icon"></i>'; }
  else if(/Windows/i.test(ua)){ system="Windows"; sysIcon='<i class="fab fa-windows device-icon"></i>'; }
  else if(/Macintosh/i.test(ua)){ system="macOS"; sysIcon='<i class="fab fa-apple device-icon"></i>'; }

  if(/Chrome/i.test(ua)){ browser="Chrome"; brIcon='<i class="fab fa-chrome browser-icon"></i>'; }
  else if(/Firefox/i.test(ua)){ browser="Firefox"; brIcon='<i class="fab fa-firefox browser-icon"></i>'; }
  else if(/Safari/i.test(ua) && !/Chrome/i.test(ua)){ browser="Safari"; brIcon='<i class="fab fa-safari browser-icon"></i>'; }
  else if(/Edg/i.test(ua)){ browser="Edge"; brIcon='<i class="fab fa-edge browser-icon"></i>'; }

  el.innerHTML = `${sysIcon}${system} &nbsp;|&nbsp; ${brIcon}${browser}`;
}
detectDevice();

// 2. IP ç±»å‹æ£€æµ‹é€»è¾‘ (æ–°å¢åŠŸèƒ½)
function getIpType(isp, org) {
  const text = (isp + " " + org).toLowerCase();
  const dcKeywords = ['cloud','vps','hosting','server','datacenter','alibaba','tencent','amazon','aws','google','azure','digitalocean','linode','vultr','ovh','hetzner'];
  
  for(let kw of dcKeywords) {
    if(text.includes(kw)) return { name: 'æœºæˆ¿/æ•°æ®ä¸­å¿ƒ', class: 'type-dc', desc: 'å¯èƒ½ä¸ºä»£ç†æˆ–çˆ¬è™« IP' };
  }
  return { name: 'ä½å®…/ISP', class: 'type-res', desc: 'åŸç”Ÿ IP' };
}

// 3. å†å²è®°å½• (ä¼˜åŒ–ç‰ˆ)
let historyIPs=[];
function addHistory(ip){
  if(historyIPs.includes(ip)) return;
  historyIPs.unshift(ip);
  if(historyIPs.length > 8) historyIPs.pop();
  
  const listEl=document.getElementById('historyList');
  listEl.innerHTML='å†å²è®°å½•: ';
  historyIPs.forEach(item=>{
    const span=document.createElement('span');
    span.textContent=item;
    span.onclick=()=>{
        document.getElementById('ipInput').value = item;
        queryIP();
    };
    listEl.appendChild(span);
  });
}

// 4. åœ°å›¾ç›¸å…³
let map = null, marker = null;
function updateMap(lat, lon, text) {
    const mapDiv = document.getElementById('map');
    mapDiv.style.display = 'block';
    if(!map) {
        map = L.map('map').setView([lat, lon], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
    } else {
        map.setView([lat, lon], 13);
    }
    if(marker) map.removeLayer(marker);
    marker = L.marker([lat, lon]).addTo(map).bindPopup(text).openPopup();
    setTimeout(() => { map.invalidateSize(); }, 300);
}

// 5. æŸ¥è¯¢æ ¸å¿ƒ
async function fetchIPInfo(ip, el, isManual = false){
  el.innerHTML='æŸ¥è¯¢ä¸­... <span class="loading"></span>';
  try{
    const url = ip ? `https://ipapi.co/${ip}/json/` : 'https://ipapi.co/json/';
    const res = await fetch(url);
    const data = await res.json();

    if(data.error) throw new Error(data.reason);

    // è·å– IP ç±»å‹
    const ipType = getIpType(data.isp || '', data.org || '');
    const countryFlag = data.country_code ? `<img class="flag" src="https://flagcdn.com/24x18/${data.country_code.toLowerCase()}.png">` : '';

    // æ¸²æŸ“ HTML (ä¿æŒåŸæœ‰çš„ç®€æ´é£æ ¼)
    el.innerHTML=`
      <strong>IP åœ°å€:</strong> ${data.ip} <br>
      <strong>å½’å±åœ°:</strong> ${data.country_name||'æœªçŸ¥'} ${countryFlag} - ${data.city||''} <br>
      <strong>è¿è¥å•†:</strong> ${data.org || data.isp} <br>
      <strong>çº¯å‡€åº¦:</strong> <span class="badge ${ipType.class}">${ipType.name}</span> <span style="font-size:12px; color:#888">(${ipType.desc})</span> <br>
      <strong>ç»çº¬åº¦:</strong> ${data.latitude}, ${data.longitude} <br>
      <strong>æ—¶åŒº:</strong> ${data.timezone}
    `;

    if(isManual && data.latitude && data.longitude) {
        addHistory(data.ip);
        updateMap(data.latitude, data.longitude, data.city);
    }

  }catch(err){ el.innerHTML='<span style="color:#ff5252">æŸ¥è¯¢å¤±è´¥: '+err.message+'</span>'; }
}

function queryIP(){
  const ip=document.getElementById('ipInput').value.trim();
  if(!ip) return alert('è¯·è¾“å…¥ IP åœ°å€');
  fetchIPInfo(ip, document.getElementById('result'), true);
}

// å›è½¦æ”¯æŒ
document.getElementById('ipInput').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') queryIP();
});

// åˆå§‹æŸ¥è¯¢
fetchIPInfo(null, document.getElementById('myIpInfo'));
</script>
</body>
</html>
