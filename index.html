<script>
  function getIPVersion(ip) {
    if (/^\d{1,3}(\.\d{1,3}){3}$/.test(ip)) return "IPv4";
    if (/^[a-fA-F0-9:]+$/.test(ip)) return "IPv6";
    return "æœªçŸ¥ç±»å‹";
  }

  function detectDevice() {
    const ua = navigator.userAgent;
    const el = document.getElementById("deviceInfo");

    let system = "æœªçŸ¥ç³»ç»Ÿ";
    let browser = "æœªçŸ¥æµè§ˆå™¨";
    let iconSystem = "";
    let iconBrowser = "";

    if (/Android/i.test(ua)) {
      system = "Android";
      iconSystem = '<i class="fab fa-android"></i>';
    } else if (/iPhone|iPad/i.test(ua)) {
      system = "iOS";
      iconSystem = '<i class="fab fa-apple"></i>';
    } else if (/Windows/i.test(ua)) {
      system = "Windows";
      iconSystem = '<i class="fab fa-windows"></i>';
    } else if (/Macintosh/i.test(ua)) {
      system = "macOS";
      iconSystem = '<i class="fab fa-apple"></i>';
    }

    if (/Chrome/i.test(ua)) {
      browser = "Chrome";
      iconBrowser = '<i class="fab fa-chrome"></i>';
    } else if (/Firefox/i.test(ua)) {
      browser = "Firefox";
      iconBrowser = '<i class="fab fa-firefox-browser"></i>';
    } else if (/Safari/i.test(ua) && !/Chrome/i.test(ua)) {
      browser = "Safari";
      iconBrowser = '<i class="fab fa-safari"></i>';
    } else if (/Edg/i.test(ua)) {
      browser = "Edge";
      iconBrowser = '<i class="fab fa-edge"></i>';
    }

    el.innerHTML = `ğŸ’» ç³»ç»Ÿï¼š${iconSystem} ${system}<br>ğŸŒ æµè§ˆå™¨ï¼š${iconBrowser} ${browser}`;
  }

  async function loadMyIP() {
    const el = document.getElementById("myIpInfo");
    const loadingEl = document.getElementById("myIpLoading");
    try {
      const resIp = await fetch("https://api.ipify.org?format=json");
      const { ip } = await resIp.json();

      const res = await fetch(`https://ipapi.co/${ip}/json`);
      const data = await res.json();
      if(data.error) throw new Error(data.reason || "æŸ¥è¯¢å¤±è´¥");

      const version = getIPVersion(ip);
      const flagUrl = data.country_code ? `https://flagcdn.com/w40/${data.country_code.toLowerCase()}.png` : '';
      const flagImg = flagUrl ? `<img src="${flagUrl}" alt="å›½æ——" class="flag" />` : '';

      el.innerHTML = `
        ğŸ“Œ IPï¼š${data.ip} ${flagImg} <br>
        ğŸ” ç±»å‹ï¼š${version} <br>
        ğŸŒ ä½ç½®ï¼š${data.city}, ${data.region}, ${data.country_name} <br>
        ğŸ“¡ ISPï¼š${data.org || 'æœªçŸ¥'} <br>
        ğŸ§­ ç»çº¬åº¦ï¼š${data.latitude}, ${data.longitude} <br>
        â° æ—¶åŒºï¼š${data.timezone}
      `;
    } catch (e) {
      el.innerText = "âŒ æŸ¥è¯¢å¤±è´¥ï¼Œè¯·ç¨åå†è¯•";
    } finally {
      loadingEl.style.display = "none";
    }
  }

  async function queryIP() {
    const ip = document.getElementById("ipInput").value.trim();
    if (!ip) {
      alert("è¯·è¾“å…¥ IP åœ°å€ï¼");
      return;
    }
    const resEl = document.getElementById("result");
    resEl.innerHTML = 'æŸ¥è¯¢ä¸­... <span class="loading"></span>';
    try {
      const res = await fetch(`https://ipapi.co/${ip}/json`);
      const data = await res.json();
      if(data.error) throw new Error(data.reason || "æŸ¥è¯¢å¤±è´¥");

      const version = getIPVersion(ip);
      const flagUrl = data.country_code ? `https://flagcdn.com/w40/${data.country_code.toLowerCase()}.png` : '';
      const flagImg = flagUrl ? `<img src="${flagUrl}" alt="å›½æ——" class="flag" />` : '';

      resEl.innerHTML = `
        ğŸ“Œ IPï¼š${data.ip} ${flagImg} <br>
        ğŸ” ç±»å‹ï¼š${version} <br>
        ğŸŒ ä½ç½®ï¼š${data.city}, ${data.region}, ${data.country_name} <br>
        ğŸ“¡ ISPï¼š${data.org || 'æœªçŸ¥'} <br>
        ğŸ§­ ç»çº¬åº¦ï¼š${data.latitude}, ${data.longitude} <br>
        â° æ—¶åŒºï¼š${data.timezone}
      `;
      saveHistory(ip);
    } catch (e) {
      resEl.innerHTML = `<span style="color:#ff5555;">âŒ æŸ¥è¯¢å¤±è´¥ï¼š${e.message}</span>`;
    }
  }

  function getHistory() {
    try {
      return JSON.parse(localStorage.getItem("ipQueryHistory")) || [];
    } catch {
      return [];
    }
  }

  function saveHistory(ip) {
    let history = getHistory();
    if (!history.includes(ip)) {
      history.unshift(ip);
      if (history.length > 5) history.pop();
      localStorage.setItem("ipQueryHistory", JSON.stringify(history));
    }
    renderHistory();
  }

  function renderHistory() {
    const history = getHistory();
    const container = document.getElementById("historyList");
    if (history.length === 0) {
      container.innerHTML = "<em>æš‚æ— æŸ¥è¯¢å†å²</em>";
      return;
    }
    container.innerHTML = "æŸ¥è¯¢å†å²: ";
    history.forEach(ip => {
      const span = document.createElement("span");
      span.textContent = ip;
      span.onclick = () => {
        document.getElementById("ipInput").value = ip;
        queryIP();
      };
      container.appendChild(span);
    });
  }

  window.onload = () => {
    detectDevice();
    loadMyIP();
    renderHistory();
  };
</script>
