<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>What Is My IP - é«˜çº§æŸ¥è¯¢</title>
<!-- å›¾æ ‡åº“ -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
<!-- åœ°å›¾æ ·å¼ (Leaflet) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
:root {
  --primary: #00e676;
  --bg: #0d1117;
  --card-bg: #1e1e1e;
  --text: #fff;
}
body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Segoe UI', sans-serif;
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  padding: 20px;
  margin: 0;
  box-sizing: border-box;
}
header {
  text-align: center;
  font-size: 2rem;
  color: var(--primary);
  font-weight: 700;
  margin-bottom: 25px;
  text-shadow: 0 0 8px rgba(0, 230, 118, 0.4);
}
/* å¸ƒå±€å®¹å™¨ */
.container {
  max-width: 800px;
  width: 100%;
  margin: 0 auto;
}
.card {
  background-color: var(--card-bg);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  border: 1px solid #333;
}
.card:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 15px rgba(0, 230, 118, 0.15);
  border-color: #444;
}
.card h2 {
  margin-top: 0;
  margin-bottom: 15px;
  color: var(--primary);
  font-size: 1.3rem;
  display: flex;
  align-items: center;
  border-bottom: 1px solid #333;
  padding-bottom: 10px;
}
.card h2 span { margin-right: 10px; }

/* è¾“å…¥æ¡†ä¸æŒ‰é’® */
.input-group { display: flex; gap: 10px; margin-bottom: 15px; }
input {
  flex: 1;
  padding: 12px;
  border-radius: 6px;
  border: 1px solid #444;
  background-color: #111;
  color: #eee;
  font-size: 15px;
  outline: none;
  transition: border 0.3s;
}
input:focus { border-color: var(--primary); }
button {
  padding: 10px 20px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  background-color: #00c853;
  color: #fff;
  font-weight: 600;
  font-size: 15px;
  transition: background 0.3s ease;
  white-space: nowrap;
}
button:hover { background-color: var(--primary); }
button:disabled { background-color: #555; cursor: not-allowed; }

/* ä¿¡æ¯å±•ç¤ºåŒº */
.info { font-size: 15px; line-height: 1.7; word-break: break-word; }
.info strong { color: #ccc; display: inline-block; width: 80px; }
.flag { width: 24px; height: auto; vertical-align: middle; margin-left: 6px; border-radius: 2px; }

/* å¤åˆ¶æŒ‰é’® */
.copy-btn {
  background: transparent;
  border: 1px solid #444;
  padding: 2px 8px;
  font-size: 12px;
  margin-left: 10px;
  color: #aaa;
}
.copy-btn:hover { background: #333; color: var(--primary); border-color: var(--primary); }

/* å†å²è®°å½• */
.history-list { margin-top: 12px; font-size: 13px; color: #aaa; display: flex; flex-wrap: wrap; gap: 8px; }
.history-tag {
  cursor: pointer;
  padding: 4px 8px;
  background: #2a2a2a;
  border-radius: 4px;
  transition: 0.2s;
  border: 1px solid #333;
}
.history-tag:hover { border-color: var(--primary); color: var(--primary); }

/* åŠ è½½åŠ¨ç”» */
.loading {
  display: inline-block;
  width: 16px; height: 16px;
  border: 2px solid var(--primary);
  border-radius: 50%;
  border-top-color: transparent;
  animation: spin 1s linear infinite;
  vertical-align: middle;
  margin-left: 8px;
}

/* åœ°å›¾å®¹å™¨ */
#map {
  height: 250px;
  width: 100%;
  margin-top: 15px;
  border-radius: 8px;
  z-index: 1; /* é˜²æ­¢é®æŒ¡ */
  display: none; /* é»˜è®¤éšè—ï¼ŒæŸ¥è¯¢æˆåŠŸåæ˜¾ç¤º */
}

footer {
  text-align: center;
  margin-top: auto;
  color: #666;
  font-size: 13px;
  padding: 20px 0;
}

.residential { color: var(--primary); }
.datacenter { color: #ff3d00; }
.device-icon, .browser-icon { margin-right: 8px; width: 20px; text-align: center; }

@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<header><i class="fa-solid fa-globe"></i> IP åœ°ç†ä½ç½®æŸ¥è¯¢</header>

<div class="container">
  <!-- å½“å‰ IP å¡ç‰‡ -->
  <div class="card">
    <h2><span>ğŸ“</span> å½“å‰ç½‘ç»œç¯å¢ƒ</h2>
    <div class="info" id="myIpInfo">
      æŸ¥è¯¢ä¸­... <span class="loading"></span>
    </div>
  </div>

  <!-- æ‰‹åŠ¨æŸ¥è¯¢å¡ç‰‡ -->
  <div class="card">
    <h2><span>ğŸ”</span> IP å½’å±åœ°æŸ¥è¯¢</h2>
    <div class="input-group">
      <input type="text" id="ipInput" placeholder="è¾“å…¥ IP åœ°å€ (ä¾‹å¦‚ 8.8.8.8)">
      <button id="searchBtn" onclick="queryIP()">æŸ¥è¯¢</button>
    </div>
    
    <!-- ç»“æœåŒºåŸŸ -->
    <div id="resultContainer" style="display:none;">
      <div class="info" id="result"></div>
      <div id="map"></div> <!-- åœ°å›¾å®¹å™¨ -->
    </div>

    <div class="history-list" id="historyList"></div>
  </div>

  <!-- è®¾å¤‡ä¿¡æ¯å¡ç‰‡ -->
  <div class="card">
    <h2><span>ğŸ–¥ï¸</span> è®¾å¤‡ä¿¡æ¯</h2>
    <div class="info" id="deviceInfo">åŠ è½½ä¸­...</div>
  </div>
</div>

<footer>
  è”ç³»æˆ‘: <a href="mailto:abc@donluox.dpdns.org" style="color:var(--primary); text-decoration:none;">abc@donluox.dpdns.org</a>
</footer>

<!-- å¼•å…¥ Leaflet åœ°å›¾ JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// --- 1. è®¾å¤‡æ£€æµ‹é€»è¾‘ ---
function detectDevice() {
  const ua = navigator.userAgent;
  const el = document.getElementById("deviceInfo");
  let system = "æœªçŸ¥ç³»ç»Ÿ", browser = "æœªçŸ¥æµè§ˆå™¨";
  let sysIcon = '<i class="fa-solid fa-desktop device-icon"></i>';
  let brIcon = '<i class="fa-solid fa-globe browser-icon"></i>';

  if (/Android/i.test(ua)) { system = "Android"; sysIcon = '<i class="fab fa-android device-icon"></i>'; }
  else if (/iPhone|iPad/i.test(ua)) { system = "iOS"; sysIcon = '<i class="fab fa-apple device-icon"></i>'; }
  else if (/Windows/i.test(ua)) { system = "Windows"; sysIcon = '<i class="fab fa-windows device-icon"></i>'; }
  else if (/Macintosh/i.test(ua)) { system = "macOS"; sysIcon = '<i class="fab fa-apple device-icon"></i>'; }
  else if (/Linux/i.test(ua)) { system = "Linux"; sysIcon = '<i class="fab fa-linux device-icon"></i>'; }

  if (/Chrome/i.test(ua)) { browser = "Chrome"; brIcon = '<i class="fab fa-chrome browser-icon"></i>'; }
  else if (/Firefox/i.test(ua)) { browser = "Firefox"; brIcon = '<i class="fab fa-firefox browser-icon"></i>'; }
  else if (/Safari/i.test(ua) && !/Chrome/i.test(ua)) { browser = "Safari"; brIcon = '<i class="fab fa-safari browser-icon"></i>'; }
  else if (/Edg/i.test(ua)) { browser = "Edge"; brIcon = '<i class="fab fa-edge browser-icon"></i>'; }

  el.innerHTML = `
    <div>${sysIcon} <strong>ç³»ç»Ÿ:</strong> ${system}</div>
    <div style="margin-top:5px;">${brIcon} <strong>æµè§ˆå™¨:</strong> ${browser}</div>
  `;
}
detectDevice();

// --- 2. å†å²è®°å½•é€»è¾‘ ---
let historyIPs = [];
function addHistory(ip) {
  // å»é‡å¹¶æ·»åŠ åˆ°å¤´éƒ¨
  historyIPs = historyIPs.filter(item => item !== ip);
  historyIPs.unshift(ip);
  if (historyIPs.length > 8) historyIPs.pop(); // åªä¿ç•™æœ€è¿‘8ä¸ª

  const listEl = document.getElementById('historyList');
  listEl.innerHTML = '<strong>å†å²è®°å½•:</strong> ';
  
  historyIPs.forEach(hIp => {
    const span = document.createElement('span');
    span.textContent = hIp;
    span.className = 'history-tag';
    span.onclick = () => {
      document.getElementById('ipInput').value = hIp;
      queryIP();
    };
    listEl.appendChild(span);
  });
}

// --- 3. åœ°å›¾åˆå§‹åŒ– ---
let map = null;
let marker = null;

function updateMap(lat, lon, city) {
  const mapContainer = document.getElementById('map');
  mapContainer.style.display = 'block';

  if (!map) {
    // åˆå§‹åŒ–åœ°å›¾
    map = L.map('map').setView([lat, lon], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors',
      maxZoom: 18
    }).addTo(map);
  } else {
    map.setView([lat, lon], 13);
  }

  if (marker) map.removeLayer(marker);
  marker = L.marker([lat, lon]).addTo(map)
    .bindPopup(`<b>${city}</b><br>IP ä½ç½®`).openPopup();
    
  // ä¿®å¤åœ°å›¾åœ¨éšè—å®¹å™¨ä¸­åˆå§‹åŒ–å¯èƒ½å¯¼è‡´æ˜¾ç¤ºä¸å…¨çš„é—®é¢˜
  setTimeout(() => { map.invalidateSize(); }, 300);
}

// --- 4. æ ¸å¿ƒæŸ¥è¯¢é€»è¾‘ ---
async function fetchIPInfo(ip, el, isManualQuery = false) {
  el.innerHTML = 'æŸ¥è¯¢ä¸­... <span class="loading"></span>';
  if(isManualQuery) document.getElementById('resultContainer').style.display = 'block';

  try {
    const url = ip ? `https://ipapi.co/${ip}/json/` : 'https://ipapi.co/json/';
    const res = await fetch(url);
    if (!res.ok) throw new Error("API è¯·æ±‚å—é™æˆ–ç½‘ç»œé”™è¯¯");
    const data = await res.json();

    if (data.error) throw new Error(data.reason || "æ— æ•ˆçš„ IP åœ°å€");

    // åˆ¤æ–­ IP ç±»å‹
    let isp = data.org || 'æœªçŸ¥';
    let ipType = 'ä½å®…/å•†ç”¨ IP';
    let typeClass = 'residential';
    const cloudKeywords = ['Amazon', 'AWS', 'Alibaba', 'Tencent', 'DigitalOcean', 'OVH', 'Google', 'Linode', 'Azure', 'Cloudflare'];
    
    if (cloudKeywords.some(k => isp.toLowerCase().includes(k.toLowerCase()))) {
      ipType = 'æ•°æ®ä¸­å¿ƒ/æœºæˆ¿ IP';
      typeClass = 'datacenter';
    }

    const countryFlag = data.country_code 
      ? `<img class="flag" src="https://flagcdn.com/24x18/${data.country_code.toLowerCase()}.png" alt="${data.country_name}">` 
      : '';

    // ç”Ÿæˆ HTML
    const htmlContent = `
      <div><strong>IP åœ°å€:</strong> <span id="ip-text-${isManualQuery?1:0}">${data.ip}</span> <button class="copy-btn" onclick="copyToClipboard('${data.ip}')"><i class="fa-regular fa-copy"></i> å¤åˆ¶</button></div>
      <div><strong>æ‰€åœ¨åœ°:</strong> ${data.country_name || ''} ${countryFlag} - ${data.region || ''} - ${data.city || ''}</div>
      <div><strong>è¿è¥å•†:</strong> ${isp}</div>
      <div><strong>ASN:</strong> ${data.asn || 'æœªçŸ¥'}</div>
      <div><strong>ç±»å‹:</strong> <span class="${typeClass}" style="font-weight:bold">${ipType}</span></div>
      <div><strong>æ—¶åŒº:</strong> ${data.timezone || ''}</div>
    `;

    el.innerHTML = htmlContent;

    // å¦‚æœæ˜¯æ‰‹åŠ¨æŸ¥è¯¢ï¼Œæ›´æ–°åœ°å›¾å’Œå†å²
    if (isManualQuery) {
      if (data.latitude && data.longitude) {
        updateMap(data.latitude, data.longitude, data.city);
      }
      addHistory(data.ip);
    }

  } catch (err) {
    el.innerHTML = `<span style="color:#ff5252"><i class="fa-solid fa-triangle-exclamation"></i> æŸ¥è¯¢å¤±è´¥: ${err.message}</span>`;
    console.error(err);
  }
}

// --- 5. è¾…åŠ©åŠŸèƒ½ ---
function queryIP() {
  const input = document.getElementById('ipInput');
  const ip = input.value.trim();
  if (!ip) return alert('è¯·è¾“å…¥ IP åœ°å€');
  
  const btn = document.getElementById('searchBtn');
  btn.disabled = true;
  btn.textContent = 'æŸ¥è¯¢ä¸­...';
  
  fetchIPInfo(ip, document.getElementById('result'), true).then(() => {
    btn.disabled = false;
    btn.textContent = 'æŸ¥è¯¢';
  });
}

// å›è½¦é”®ç›‘å¬
document.getElementById('ipInput').addEventListener('keypress', function (e) {
  if (e.key === 'Enter') queryIP();
});

function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => {
    alert('IP å·²å¤åˆ¶åˆ°å‰ªè´´æ¿: ' + text);
  }).catch(err => {
    console.error('å¤åˆ¶å¤±è´¥', err);
  });
}

// --- 6. åˆå§‹åŒ– ---
// é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æŸ¥å½“å‰ IP
fetchIPInfo(null, document.getElementById('myIpInfo'));

</script>
</body>
</html>
