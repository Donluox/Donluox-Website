<!DOCTYPE html>
<html lang="zh">
<head>
  <!--
    What Is My IP - 稳定、可读、带纯净度与机房识别的版本
    说明：
    1) 完整注释 + 模块化函数，冗余但更稳妥易维护。
    2) 仅前端实现：使用 ipify + ipapi.co + AbuseIPDB（需要你的 API Key）。
    3) 注意：把 AbuseIPDB Key 放在前端会暴露给所有访客，仅限自用/测试。
  -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>What Is My IP</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- ===================== 全局样式（保持完整，不做压缩） ===================== -->
  <style>
    /* 页面基础 */
    body {
      background-color: #111;           /* 深色背景提升对比度 */
      color: #fff;                      /* 文字统一白色 */
      font-family: 'Segoe UI', sans-serif;
      padding: 30px;                    /* 内容留白 */
      display: flex;                    /* 保持 footer 底部 */
      flex-direction: column;
      min-height: 100vh;
    }

    /* 顶部标题 */
    header {
      text-align: center;
      font-size: 2.5rem;
      font-weight: 700;
      color: #00e676;                   /* 品牌绿色 */
      margin-bottom: 30px;
      user-select: none;
      letter-spacing: 0.1em;
      text-shadow: 0 0 8px #00e676aa;   /* 轻微发光效果 */
    }

    /* 卡片容器：用于模块分区 */
    .card {
      background-color: #1e1e1e;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.05);
      transition: all 0.4s ease-in-out;
      animation: fadeIn 0.6s ease;
    }

    /* 悬浮微动效（可去除，不影响功能） */
    .card:hover {
      transform: scale(1.01);
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
    }

    /* 输入框样式 */
    .input-group { margin-bottom: 20px; }
    input[type="text"] {
      width: 100%;
      padding: 10px 15px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
      outline: none;
      background-color: #222;
      color: #eee;
    }

    /* 按钮样式 */
    button {
      margin-top: 10px;
      padding: 10px 20px;
      font-size: 16px;
      background-color: #00c853;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      color: #fff;
      transition: background 0.3s ease;
    }
    button:hover { background-color: #00e676; }

    /* 信息块文字行距 */
    .info span {
      display: block;
      margin-top: 10px;
      font-size: 16px;
    }

    /* 图标和国旗 */
    .icon { font-size: 18px; margin-right: 6px; }
    .flag {
      width: 24px;
      height: 16px;
      vertical-align: middle;
      margin-left: 6px;
      border-radius: 2px;
      box-shadow: 0 0 3px rgba(0,0,0,0.3);
    }

    /* 查询历史 */
    .history-list {
      margin-top: 10px;
      font-size: 14px;
      color: #aaa;
    }
    .history-list span {
      cursor: pointer;
      color: #00e676;
      margin-right: 12px;
      user-select: none;
    }
    .history-list span:hover { text-decoration: underline; }

    /* 加载动画 */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #00e676;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
      vertical-align: middle;
      margin-left: 10px;
    }

    /* 纯净度条 - 容器 */
    .purity-bar {
      width: 100%;
      height: 14px;
      border-radius: 8px;
      background: #2a2a2a;             /* 背景槽 */
      overflow: hidden;
      margin-top: 8px;
      border: 1px solid #333;
    }

    /* 纯净度条 - 填充 */
    .purity-fill {
      height: 100%;
      width: 0%;                        /* 运行时设置 */
      transition: width 0.5s ease;      /* 平滑动画 */
      background: #00e676;              /* 运行时根据分数改色 */
    }

    /* 状态色（文本用） */
    .purity-green { color: #00e676; font-weight: 600; }
    .purity-yellow { color: #ffeb3b; font-weight: 600; }
    .purity-red   { color: #ff5252; font-weight: 600; }

    /* 页脚 */
    footer {
      margin-top: auto;
      text-align: center;
      color: #777;
      font-size: 14px;
      padding: 15px 0;
      user-select: none;
      border-top: 1px solid #222;
    }

    /* 小动画 */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px);} to { opacity: 1; transform: translateY(0);} }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <!-- ===================== 页面结构 ===================== -->
  <header>What Is My IP</header>

  <!-- 当前 IP 卡片 -->
  <div class="card" aria-live="polite" aria-busy="true">
    <h2>🌐 当前 IP 查询</h2>
    <div class="info" id="myIpInfo">查询中... <span class="loading" id="myIpLoading"></span></div>
    <!-- 纯净度模块（当前 IP） -->
    <div class="info" id="myIpPurity"></div>
  </div>

  <!-- 手动查询卡片 -->
  <div class="card" aria-live="polite">
    <h2>🔍 手动查询其他 IP</h2>
    <div class="input-group">
      <input type="text" id="ipInput" placeholder="输入 IP 地址" aria-label="输入要查询的 IP 地址" autocomplete="off" />
      <button id="queryBtn" type="button" aria-label="开始查询" onclick="queryIP()">查询</button>
    </div>
    <div class="info" id="result"></div>
    <!-- 纯净度模块（手动查询结果） -->
    <div class="info" id="resultPurity"></div>
    <div class="history-list" id="historyList"></div>
  </div>

  <!-- 设备信息卡片 -->
  <div class="card">
    <h2>🖥️ 用户设备 / 浏览器</h2>
    <div class="info" id="deviceInfo">加载中...</div>
  </div>

  <!-- 页脚 -->
  <footer>
    联系我: <a href="mailto:yanyu4782@gmail.com" style="color:#00e676; text-decoration:none;">yanyu4782@gmail.com</a>
  </footer>

  <!-- ===================== 脚本（详细注释 + 模块化） ===================== -->
  <script>
    // =============================================================
    // 配置区：在这里填写你的 AbuseIPDB API Key
    // 警告：Key 放在前端会暴露给所有人，仅限自用/测试。
    // =============================================================
    const ABUSE_API_KEY = "7ff20287c065632f6351c61f84877fe819494b5c1342ee28bf26edf623d4bdf21ecaef989e58b416";

    // =============================================================
    // 工具函数：IP 版本判断（维持与原逻辑一致，IPv6 使用全写匹配）
    // =============================================================
    function getIPVersion(ip) {
      const ipv4Pattern = /^(25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)){3}$/;
      // IPv6 这里沿用原始的“全 8 组”匹配，保证与原逻辑一致性与稳定性
      const ipv6Pattern = /^(([0-9a-fA-F]{1,4}):){7}([0-9a-fA-F]{1,4})$/;
      if (ipv4Pattern.test(ip)) return "IPv4";
      if (ipv6Pattern.test(ip)) return "IPv6";
      return "未知类型";
    }

    // =============================================================
    // 设备指纹（仅基于 UA 简单判断，足够稳定）
    // =============================================================
    function detectDevice() {
      const ua = navigator.userAgent;
      const el = document.getElementById("deviceInfo");

      let system = "未知系统";
      let browser = "未知浏览器";
      let iconSystem = "";
      let iconBrowser = "";

      // 系统判断
      if (/Android/i.test(ua)) { system = "Android"; iconSystem = '<i class="fab fa-android"></i>'; }
      else if (/iPhone|iPad/i.test(ua)) { system = "iOS"; iconSystem = '<i class="fab fa-apple"></i>'; }
      else if (/Windows/i.test(ua)) { system = "Windows"; iconSystem = '<i class="fab fa-windows"></i>'; }
      else if (/Macintosh/i.test(ua)) { system = "macOS"; iconSystem = '<i class="fab fa-apple"></i>'; }

      // 浏览器判断
      if (/Chrome\//i.test(ua)) { browser = "Chrome"; iconBrowser = '<i class="fab fa-chrome"></i>'; }
      else if (/Firefox\//i.test(ua)) { browser = "Firefox"; iconBrowser = '<i class="fab fa-firefox-browser"></i>'; }
      else if (/Safari\//i.test(ua) && !/Chrome\//i.test(ua)) { browser = "Safari"; iconBrowser = '<i class="fab fa-safari"></i>'; }
      else if (/Edg\//i.test(ua)) { browser = "Edge"; iconBrowser = '<i class="fab fa-edge"></i>'; }

      el.innerHTML = `💻 系统：${iconSystem} ${system}<br>🌐 浏览器：${iconBrowser} ${browser}`;
    }

    // =============================================================
    // 纯净度条：渲染为进度条 + 文本（稳定简单）
    // purityPercent: 0-100 的数值；container: DOM 容器
    // =============================================================
    function renderPurityBar(purityPercent, container) {
      // 先清空容器
      container.innerHTML = "";

      // 创建文字描述
      const label = document.createElement('div');
      const purityText = `🛡️ 纯净度：${purityPercent}%`;
      // 根据阈值设置文字颜色（绿色>=70，黄色20-69，红色<20）
      if (purityPercent >= 70) {
        label.className = 'purity-green';
      } else if (purityPercent >= 20) {
        label.className = 'purity-yellow';
      } else {
        label.className = 'purity-red';
      }
      label.textContent = purityText;
      container.appendChild(label);

      // 进度条容器
      const bar = document.createElement('div');
      bar.className = 'purity-bar';
      bar.setAttribute('role', 'progressbar');
      bar.setAttribute('aria-valuemin', '0');
      bar.setAttribute('aria-valuemax', '100');
      bar.setAttribute('aria-valuenow', String(purityPercent));

      // 进度条填充
      const fill = document.createElement('div');
      fill.className = 'purity-fill';
      fill.style.width = purityPercent + '%';

      // 根据阈值调色（与文字一致）
      if (purityPercent >= 70) fill.style.background = '#00e676';
      else if (purityPercent >= 20) fill.style.background = '#ffeb3b';
      else fill.style.background = '#ff5252';

      bar.appendChild(fill);
      container.appendChild(bar);
    }

    // =============================================================
    // AbuseIPDB 查询：返回 { purityPercent, usageText, isHosting, rawScore }
    // 注：abuseConfidenceScore 越高越“脏”，我们用 100-score 作为纯净度
    // =============================================================
    async function fetchAbuseInfo(ip) {
      const endpoint = `https://api.abuseipdb.com/api/v2/check?ipAddress=${encodeURIComponent(ip)}&maxAgeInDays=90`;
      const headers = { 'Key': ABUSE_API_KEY, 'Accept': 'application/json' };

      try {
        const res = await fetch(endpoint, { headers });
        if (!res.ok) {
          // 非 2xx，返回兜底结果，保持稳定
          return { ok: false, message: '接口响应异常', purityPercent: null, usageText: null, isHosting: null, rawScore: null };
        }
        const json = await res.json();
        if (!json || !json.data) {
          return { ok: false, message: '数据为空', purityPercent: null, usageText: null, isHosting: null, rawScore: null };
        }

        const score = Number(json.data.abuseConfidenceScore || 0); // 0-100（高=坏）
        const usage = json.data.usageType || '未知';                // 例如：Data Center/Web Hosting/Transit
        const purity = Math.max(0, Math.min(100, 100 - score));     // 转成纯净度

        // 机房/数据中心判定关键字（更稳妥些，大小写不敏感）
        const hostingKeywords = ['hosting', 'data center', 'datacenter', 'transit', 'cloud'];
        const usageLower = usage.toLowerCase();
        const isHosting = hostingKeywords.some(k => usageLower.includes(k));

        return {
          ok: true,
          message: 'ok',
          purityPercent: purity,
          usageText: usage,
          isHosting,
          rawScore: score
        };
      } catch (err) {
        // 网络错误等情况，稳定返回兜底
        return { ok: false, message: '网络错误', purityPercent: null, usageText: null, isHosting: null, rawScore: null };
      }
    }

    // =============================================================
    // 渲染纯净度信息：文本 + 进度条 + 用途/类型判断
    // =============================================================
    function renderPurityInfo(result, container) {
      // 先清空
      container.innerHTML = '';

      if (!result || !result.ok || result.purityPercent === null) {
        container.innerHTML = "<span style='color:#ff5555;'>⚠️ 无法检测纯净度</span>";
        return;
      }

      // 1) 纯净度条
      renderPurityBar(result.purityPercent, container);

      // 2) 类型与用途
      const typeLine = document.createElement('div');
      typeLine.style.marginTop = '8px';
      typeLine.innerHTML = `🏢 类型：${ result.isHosting ? '机房 / 数据中心' : '家庭原生IP' }`;
      container.appendChild(typeLine);

      const usageLine = document.createElement('div');
      usageLine.style.opacity = '0.85';
      usageLine.textContent = `📋 用途标记：${result.usageText}`;
      container.appendChild(usageLine);
    }

    // =============================================================
    // 查询“当前 IP”并渲染
    // =============================================================
    async function loadMyIP() {
      const el = document.getElementById('myIpInfo');
      const loadingEl = document.getElementById('myIpLoading');
      const purityBox = document.getElementById('myIpPurity');

      // 每次加载前清空纯净度区域
      purityBox.innerHTML = '';

      try {
        // 1) 取本机 IP
        const resIp = await fetch('https://api.ipify.org?format=json');
        const { ip } = await resIp.json();

        // 2) 取地理/ISP 信息
        const ipVersion = getIPVersion(ip);
        const res = await fetch(`https://ipapi.co/${ip}/json`);
        const data = await res.json();
        if (data.error) throw new Error(data.reason || '查询失败');

        // 3) 国旗图标
        const flagUrl = data.country_code ? `https://flagcdn.com/w40/${String(data.country_code).toLowerCase()}.png` : '';
        const flagImg = flagUrl ? `<img src="${flagUrl}" alt="国旗" class="flag" />` : '';

        // 4) 渲染基本信息
        el.innerHTML = [
          `📌 IP：${data.ip} (${ipVersion}) ${flagImg}`,
          `🌍 位置：${data.city || '-'}, ${data.region || '-'}, ${data.country_name || '-'}`,
          `📡 ISP：${data.org || '未知'}`,
          `🧭 经纬度：${data.latitude || '-'}, ${data.longitude || '-'}`,
          `⏰ 时区：${data.timezone || '-'}`
        ].join('<br>');

        // 5) 渲染纯净度（分步渲染，保障稳定）
        purityBox.textContent = '检测纯净度中...';
        const abuse = await fetchAbuseInfo(ip);
        renderPurityInfo(abuse, purityBox);

      } catch (e) {
        // 失败兜底
        el.innerText = '❌ 查询失败，请稍后再试';
        purityBox.innerHTML = '';
      } finally {
        // 去除 loading
        if (loadingEl) loadingEl.style.display = 'none';
      }
    }

    // =============================================================
    // 手动查询任意 IP 并渲染
    // =============================================================
    async function queryIP() {
      const ipInput = document.getElementById('ipInput');
      const ip = (ipInput.value || '').trim();
      if (!ip) { alert('请输入 IP 地址！'); return; }

      const resEl = document.getElementById('result');
      const purityBox = document.getElementById('resultPurity');

      // 预先清理 UI
      resEl.innerHTML = '查询中... <span class="loading"></span>';
      purityBox.innerHTML = '';

      try {
        const res = await fetch(`https://ipapi.co/${encodeURIComponent(ip)}/json`);
        const data = await res.json();
        if (data.error) throw new Error(data.reason || '查询失败');

        const ipVersion = getIPVersion(ip);
        const flagUrl = data.country_code ? `https://flagcdn.com/w40/${String(data.country_code).toLowerCase()}.png` : '';
        const flagImg = flagUrl ? `<img src="${flagUrl}" alt="国旗" class="flag" />` : '';

        resEl.innerHTML = [
          `📌 IP：${data.ip} (${ipVersion}) ${flagImg}`,
          `🌍 位置：${data.city || '-'}, ${data.region || '-'}, ${data.country_name || '-'}`,
          `📡 ISP：${data.org || '未知'}`,
          `🧭 经纬度：${data.latitude || '-'}, ${data.longitude || '-'}`,
          `⏰ 时区：${data.timezone || '-'}`
        ].join('<br>');

        // 渲染纯净度
        purityBox.textContent = '检测纯净度中...';
        const abuse = await fetchAbuseInfo(ip);
        renderPurityInfo(abuse, purityBox);

        // 保存历史
        saveHistory(ip);

      } catch (e) {
        resEl.innerHTML = `<span style="color:#ff5555;">❌ 查询失败：${e.message}</span>`;
        purityBox.innerHTML = '';
      }
    }

    // =============================================================
    // 查询历史：本地持久化（localStorage）
    // =============================================================
    function getHistory() {
      try {
        return JSON.parse(localStorage.getItem('ipQueryHistory')) || [];
      } catch {
        return [];
      }
    }

    function saveHistory(ip) {
      let history = getHistory();
      // 去重 + 头部插入
      history = history.filter(item => item !== ip);
      history.unshift(ip);
      // 最多保留 8 条（更实用）
      if (history.length > 8) history = history.slice(0, 8);
      localStorage.setItem('ipQueryHistory', JSON.stringify(history));
      renderHistory();
    }

    function renderHistory() {
      const history = getHistory();
      const container = document.getElementById('historyList');

      if (!container) return;

      if (history.length === 0) {
        container.innerHTML = '<em>暂无查询历史</em>';
        return;
      }

      // 生成可点击的历史项
      container.innerHTML = '查询历史: ';
      history.forEach(ip => {
        const span = document.createElement('span');
        span.textContent = ip;
        span.title = '点击重新查询 ' + ip;
        span.onclick = () => {
          document.getElementById('ipInput').value = ip;
          queryIP();
        };
        container.appendChild(span);
      });

      // 加一个清空按钮以保证可控性（可选）
      const clearBtn = document.createElement('button');
      clearBtn.textContent = '清空历史';
      clearBtn.style.marginLeft = '10px';
      clearBtn.onclick = () => {
        localStorage.removeItem('ipQueryHistory');
        renderHistory();
      };
      container.appendChild(clearBtn);
    }

    // =============================================================
    // 初始化入口：按顺序执行，确保页面稳定
    // =============================================================
    window.onload = () => {
      try {
        detectDevice();     // 1) 渲染设备信息
        renderHistory();    // 2) 渲染历史（即使为空也稳定）
        loadMyIP();         // 3) 查询当前 IP（异步）
      } catch (e) {
        // 整体兜底（基本不会触发）
        console.error('初始化失败', e);
      }
    };
  </script>
</body>
</html>
